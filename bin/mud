#!/usr/bin/env php
<?php
declare(strict_types=1);

require_once __DIR__.'/../bootstrap.php';

use PhpMud\Fixture\AreaFixture;
use PhpMud\Fixture\ItemFixture;
use PhpMud\Fixture\MobFixture;
use PhpMud\Fixture\RoomFixture;
use PhpMud\Entity\Area;
use PhpMud\Entity\Room;
use PhpMud\Entity\Item;
use PhpMud\Entity\Mob;
use PhpMud\Entity\Shopkeeper;
use PhpMud\Enum\Material;
use PhpMud\Direction\West;
use PhpMud\Race\Dwarf;
use PhpMud\Race\Human;
use PhpMud\Server;

define('START_ROOM', 1);

$room = $em->getRepository(Room::class)->find(START_ROOM);

if (!$room) {
    echo "creating initial world fixtures\n";

    $area = new AreaFixture(new Area('Midgaard'));
    $room = $area->addRoom(
        (new RoomFixture(
            new Room(
                'Midgaard Town Center',
                'Before you is the town center.'
            )
        ))->setArea(
            $area->getInstance()
        )->addItems([
            new Item('a copper teapot', Material::COPPER(), ['copper', 'teapot']),
            (new ItemFixture(
                new Item(
                    'a wooden sword',
                    Material::WOOD(),
                    ['wooden', 'sword']
                )
            ))->setPosition(\PhpMud\Enum\Position::WIELDED())->getInstance(),
            (new ItemFixture(
                new Item(
                    'a wooden mace',
                    Material::WOOD(),
                    ['wooden', 'mace']
                )
            ))->setPosition(\PhpMud\Enum\Position::WIELDED())->getInstance()
        ])->addMob(
            (new MobFixture(
                new Mob(
                    'a janitor',
                    new Human()
                )
            ))->getInstance()
        )->addRoom(
            new West(),
            (new RoomFixture(
                new Room(
                    'Merriarmour Arms and Armour',
'  A cramped shop is filled with cheap but sturdy training equipment. A red-hot forge
and workshop fill the back half of the already small space. The silhouette of a dwarf 
can be seen in front of the forge, hammering out new weapons and armor.'
                )
            ))->addMob(
                (new MobFixture(
                    new Shopkeeper(
                        'Mornolum Merriarmour',
                        new Dwarf()
                    )
                ))->setLook('totters around, stinking up the place.')
                ->addItem(
                    (new ItemFixture(
                        new Item(
                            'a small brass key',
                            Material::BRASS(),
                            ['small', 'brass', 'key']
                        )
                    ))->setValue(20)
                    ->getInstance()
                )
                ->getInstance()
            )->setArea($area->getInstance())
        )
    )->getInstance()->getRooms()->first();
}

(new Server($em, $room))->listen($config['ip'], $config['port']);