#!/usr/bin/env php

<?php

require_once __DIR__.'/../bootstrap.php';

/** @var \Doctrine\ORM\EntityManager $em */
$em = $container->get(\PhpMud\Enum\ContainerService::EM);
$roomRepository = $em->getRepository(\PhpMud\Entity\Room::class);
$room = $roomRepository->find(1);

if (!$room) {
    echo "creating new room\n";
    $room = new \PhpMud\Entity\Room();
    $room->setTitle('title');
    $room->setDescription('foo');

    $em->persist($room);
    $em->flush();
}

$loop = React\EventLoop\Factory::create();
$socket = new React\Socket\Server($loop);
$server = new PhpMud\Server($em, $room);
$server->listen($socket, 9000);
$loop->addPeriodicTimer(0, [$server, 'heartbeat']);
$loop->addPeriodicTimer(1, [$server, 'pulse']);
$server->tick($loop);
$loop->run();